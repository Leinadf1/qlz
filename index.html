<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Magazzino</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f4; padding: 20px; }
        
        /* Stile dei Filtri Peso */
        .filters { margin-bottom: 20px; text-align: center; }
        .filter-btn {
            background: #fff; border: 1px solid #ddd; padding: 10px 20px;
            margin: 5px; border-radius: 20px; cursor: pointer; font-weight: bold;
        }
        .filter-btn.active { background: #007bff; color: white; border-color: #007bff; }

        /* Griglia Prodotti */
        #product-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        /* Stile Card Prodotto (Simile alla tua foto) */
        .card {
            background: white; border-radius: 15px; padding: 15px;
            display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .card img {
            width: 80px; height: 100px; object-fit: contain; margin-right: 15px;
        }
        .info { flex-grow: 1; }
        .weight { font-weight: bold; font-size: 1.1em; color: #333; }
        .name { color: #555; margin-bottom: 10px; }
        
        /* Controlli Quantità */
        .controls {
            background: #f0f0f0; border-radius: 10px; padding: 5px 15px;
            display: flex; align-items: center; justify-content: space-between;
            min-width: 120px;
        }
        .qty { font-size: 1.5em; font-weight: bold; margin: 0 15px; }
        .btn {
            font-size: 1.5em; cursor: pointer; border: none; background: none; font-weight: bold;
        }
        .btn-minus { color: #d9534f; } /* Rosso */
        .btn-plus { color: #5cb85c; }  /* Verde */
        
        .loading { text-align: center; width: 100%; font-size: 1.2em; color: #666; }
    </style>
</head>
<body>

    <h2 style="text-align:center;">Gestione Inventario</h2>

    <div class="filters" id="filters">
        <button class="filter-btn active" onclick="filterProducts('all')">Tutti</button>
        </div>

    <div id="product-container">
        <div class="loading">Caricamento prodotti...</div>
    </div>

    <script>
        // INCOLLA QUI IL TUO URL DI APPS SCRIPT (quello che finisce con /exec)
        const SCRIPT_URL = 'INSERISCI_QUI_IL_TUO_URL_APPS_SCRIPT';

        let allProducts = [];

        // 1. Carica i dati all'avvio
        async function loadProducts() {
            try {
                const response = await fetch(SCRIPT_URL);
                allProducts = await response.json();
                generateWeightFilters();
                renderProducts(allProducts);
            } catch (error) {
                console.error("Errore:", error);
                document.getElementById('product-container').innerHTML = "Errore nel caricamento dati.";
            }
        }

        // 2. Genera i bottoni filtro in base ai pesi presenti
        function generateWeightFilters() {
            const weights = [...new Set(allProducts.map(p => p.weight))]; // Pesi unici
            const filterContainer = document.getElementById('filters');
            
            weights.forEach(w => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.innerText = w;
                btn.onclick = () => filterProducts(w);
                filterContainer.appendChild(btn);
            });
        }

        // 3. Filtra la visualizzazione
        function filterProducts(weight) {
            // Aggiorna stile bottoni
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (weight === 'all') {
                renderProducts(allProducts);
            } else {
                const filtered = allProducts.filter(p => p.weight === weight);
                renderProducts(filtered);
            }
        }

        // 4. Mostra le card a schermo
        function renderProducts(products) {
            const container = document.getElementById('product-container');
            container.innerHTML = '';

            products.forEach(p => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <img src="${p.image || 'https://via.placeholder.com/80'}" alt="Foto">
                    <div class="info">
                        <div class="weight">${p.weight}</div>
                        <div class="name">${p.name}</div>
                    </div>
                    <div class="controls">
                        <button class="btn btn-minus" onclick="updateQty('${p.id}', 'remove', this)">-1</button>
                        <span class="qty">${p.qty}</span>
                        <button class="btn btn-plus" onclick="updateQty('${p.id}', 'add', this)">+1</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 5. Aggiorna la quantità (Chiama Apps Script)
        function updateQty(id, action, btnElement) {
            // Aggiorna subito l'interfaccia (Feedback visivo immediato)
            const qtySpan = btnElement.parentElement.querySelector('.qty');
            let currentQty = parseInt(qtySpan.innerText);
            
            if (action === 'remove' && currentQty > 0) currentQty--;
            if (action === 'add') currentQty++;
            
            qtySpan.innerText = currentQty;

            // Invia i dati a Google Sheet in background
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ id: id, action: action })
            }).then(res => console.log("Aggiornato su Drive"));
        }

        // Avvia tutto
        loadProducts();
    </script>
</body>
</html>
